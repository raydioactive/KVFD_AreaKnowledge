# Offline Setup Guide

## Critical Requirement

**This app MUST work 100% offline after initial setup.** This is essential for:
- EMS training in areas with poor connectivity
- Realistic field simulation scenarios
- Reliability during actual training sessions

## Setup Process

### Step 1: Download Data (One-Time, Requires Internet)

Run the automated download and tile generation script:

```bash
python scripts/download_tiles.py
```

This will:
1. Download Maryland OSM data (~50 MB)
2. Download GraphHopper routing engine (~30 MB)
3. Download Planetiler tile generator (~50 MB)
4. **Generate offline map tiles** (5-15 minutes, ~200-500 MB)

**Total Time:** 10-20 minutes
**Total Download:** ~130 MB
**Generated Data:** ~200-500 MB

### Step 2: Verify Data Files

Check that these files exist:

```
C:\Users\julih\Coding\KVFD_Quiz\
├── routing/
│   ├── graphhopper/
│   │   ├── graphhopper-web-8.0.jar          (~30 MB)
│   │   ├── maryland-latest.osm.pbf           (~50 MB)
│   │   └── graph-cache/                      (created on first GraphHopper run)
│   └── planetiler/
│       └── planetiler.jar                     (~50 MB)
└── tiles/
    └── maryland.mbtiles                       (~200-500 MB)
```

### Step 3: Test Offline Mode

1. **Disconnect from internet** (disable WiFi/unplug ethernet)

2. Start all services:
   ```bash
   # Terminal 1 - Backend
   cd backend
   venv\Scripts\activate
   python -m uvicorn app.main:app --reload

   # Terminal 2 - GraphHopper
   python routing/start_graphhopper.py

   # Terminal 3 - Frontend
   cd frontend
   npm run dev

   # Terminal 4 - Electron
   set SKIP_PYTHON_SPAWN=true
   npm run dev
   ```

3. **Verify offline functionality:**
   - [ ] Map displays (should show Maryland)
   - [ ] Toggle between Training/Reference modes works
   - [ ] Training mode shows map WITHOUT street labels
   - [ ] Reference mode shows map WITH street labels
   - [ ] Click two points on map
   - [ ] Route calculates successfully
   - [ ] Turn-by-turn directions display

4. **Reconnect to internet** - app should still work the same

## Troubleshooting

### Map Tiles Not Loading

**Symptom:** Blank gray map or "Tiles not available" error

**Check:**
```bash
# Verify MBTiles file exists
ls -lh tiles/maryland.mbtiles

# Test tile server health
curl http://127.0.0.1:8000/tiles/health
```

**Fix:**
```bash
# Regenerate tiles
python scripts/download_tiles.py --tiles-only --force
```

### Routing Fails

**Symptom:** "Failed to calculate route" error

**Check:**
```bash
# Verify GraphHopper is running
curl http://127.0.0.1:8989/health
```

**Fix:**
```bash
# Restart GraphHopper
python routing/start_graphhopper.py
```

### Tile Server Returns 503

**Symptom:** Backend logs show "MBTiles file not found"

**Root Cause:** Tiles were not generated

**Fix:**
```bash
# Generate tiles
python scripts/download_tiles.py --tiles-only
```

## Technical Details

### Map Tile Format

- **Format:** MBTiles (SQLite database of vector tiles)
- **Schema:** OpenMapTiles (generated by Planetiler)
- **Zoom Levels:** 0-14 (good balance for regional mapping)
- **Coordinate System:** Web Mercator (EPSG:3857)
- **Tile Format:** PBF (Protocol Buffers, gzip compressed)

### Tile Server Architecture

1. **Frontend** requests tile: `http://127.0.0.1:8000/tiles/{z}/{x}/{y}.pbf`
2. **FastAPI tile router** converts XYZ → TMS coordinates
3. **SQLite query** retrieves tile from MBTiles database
4. **PBF tile** returned with gzip encoding

### Map Styles

**Training Mode** (`tiles/styles/training-mode.json`):
- Vector tile style
- NO street labels, place names, or text
- Visual-only geographic features (roads, water, buildings)
- Forces trainees to learn geography by landmarks

**Reference Mode** (`tiles/styles/reference-mode.json`):
- Same vector tiles as training mode
- WITH street labels, place names, road names
- For checking answers and studying

**Key Difference:** Only the style changes, same tiles used for both modes!

### Offline Data Size Breakdown

| Component | Size | Purpose |
|-----------|------|---------|
| Maryland OSM PBF | ~50 MB | Source data for tiles & routing |
| Planetiler JAR | ~50 MB | Tile generation tool (Java) |
| GraphHopper JAR | ~30 MB | Routing engine (Java) |
| **Generated MBTiles** | **~200-500 MB** | **Offline vector tiles** |
| GraphHopper cache | ~100-200 MB | Routing graph (first run) |
| **TOTAL** | **~500-1000 MB** | **Full offline capability** |

## Development Workflow

### With Internet (Phase 2 Testing)

Use this during development when internet is available:

```bash
# Skip tile download, use online fallback if needed
npm run dev
```

### Without Internet (Production Simulation)

Test the full offline experience:

```bash
# 1. Ensure tiles are generated
python scripts/download_tiles.py

# 2. Disable internet
# (WiFi off or ethernet unplugged)

# 3. Start app normally
# All features should work!
```

## Error Handling

The app includes proper error messages for missing data:

### Missing Tiles
```
HTTP 503: Map tiles not available. Please run: python scripts/download_tiles.py
```

### Missing OSM Data
```
✗ OSM data not found. Please download first.
  Run: python scripts/download_tiles.py --osm-only
```

### GraphHopper Not Running
```
Routing error: Connection refused (localhost:8989)
```

**User sees:** Clear error message with next steps
**Never:** Silent failure or broken UI

## Production Deployment

For the packaged desktop app (future):

1. **First Run Wizard:**
   - Download tiles on first app launch
   - Show progress bar during generation
   - Allow user to skip (use online fallback temporarily)

2. **Update Mechanism:**
   - Check for new Maryland OSM data monthly
   - Allow user to update tiles manually
   - Keep old tiles until new ones are validated

3. **Disk Space Management:**
   - Warn if <2GB free space
   - Allow user to delete old tile versions
   - Compress tiles if needed

## Next Phase

After confirming offline mode works:

**Phase 3:** Import Montgomery County GIS data (hospitals, fire stations, beats)
- Download MoCo facility data (one-time)
- Import into SQLite database
- Display markers on map
- All still works offline!

## Success Criteria

✅ **Phase 2 Complete When:**

- [ ] Tiles generated successfully from OSM data
- [ ] Map displays offline (internet disconnected)
- [ ] Training mode shows NO labels
- [ ] Reference mode shows labels (roads, cities)
- [ ] Toggle switches between modes seamlessly
- [ ] Routing works offline (GraphHopper)
- [ ] Turn-by-turn directions display correctly
- [ ] No internet requests after initial setup
- [ ] Error messages are clear and actionable

**Ready for Phase 3:** Facility data import and display
